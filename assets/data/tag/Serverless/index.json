{"hash":"1a485f6dceb298c3ce36b831edab4aa62783906c","data":{"tag":{"title":"Serverless","belongsTo":{"edges":[{"node":{"title":"Hit count：用 Google Analytics + Vercel Serverless 为文章添加浏览量统计","path":"/2020/06/serverless-ga-hit-count-api/","date":"June 25. 2020","timeToRead":10,"cjkWordCount":2571,"cjkReadTime":12,"description":"借助 Google Analytics 为数据支撑，使用 Vercel Serverless 为静态博客添加文章阅读数量统计 API。","content":"<div class=\"admonition admonition-note\"><div class=\"admonition-heading\"><h5><div class=\"admonition-icon\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"14\" height=\"16\" viewBox=\"0 0 14 16\"><path fill-rule=\"evenodd\" d=\"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z\"></path></svg></div>🍍 编者按</h5></div><div class=\"admonition-content\"><p>本文灵感和部分方法极大程度来源于 @printempw 的文章：<a href=\"https://printempw.github.io/google-analytics-api-page-views-counter/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">使用 Google Analytics API 实现博客阅读量统计</a>，感谢。(　o=^•ェ•)o</p></div></div>\n<p>静态网站是没有后端服务的，仅有一个前端页面用来渲染网站的全部内容。虽然从部署、管理和访问速度的角度来说，静态网站还是有点优势的，但是没有后端就意味着没有「评论系统」、「浏览量统计」、「登录鉴权」等等功能。如果想要实现这些功能，就必须依赖第三方的服务，才能实现类似的需要。许多同学都像我一样：在自己的博客网站里使用 Google Analytics 用来统计访问量和阅读数，因此对于「浏览量统计」这个功能来说，我们其实可以借助 Google Analytics API 来将我们在管理后台看到的部分数据显示在网站前端里面，从而实现「文章访问、阅读数量」显示的功能。</p>\n<h2 id=\"工作原理\"><a href=\"#%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>工作原理</h2>\n<p>Google Analytics 非常强大，能够从非常多的维度来解读你网站的访客来源、浏览量、浏览设备等多种数据。这里当我们进入 Google Analytics 管理后台，在首页我们就可以看到我们网站每个路径在特定时间段之中的浏览数量。</p>\n<figure><img src=\"https://cdn.spencer.felinae98.cn/blog/2020/07/20200722-213128.png\" alt=\"Google Analytics 管理后台中我的博客上周 7 天的每个路径浏览数\"><figcaption>Google Analytics 管理后台中我的博客上周 7 天的每个路径浏览数</figcaption></figure>\n<p>实际上我们需要的就是这个数据。幸好，Google Analytics 提供了类似的 API，可以让我们根据页面路径、时间起止等参数来查询浏览数量。不过 Google Analytics 的原始 API 其实还是比较复杂的，而且其本身在国内访问还是不太顺畅，所以为了减轻我们静态网站前端的负担，<strong>我们可以在 Vercel 上面用 Serverless 方案部署一个 API 中转站</strong>，方便我们静态网站调用，从而实现「文章浏览量显示」的功能。</p>\n<h2 id=\"开启-google-analytics-api\"><a href=\"#%E5%BC%80%E5%90%AF-google-analytics-api\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>开启 Google Analytics API</h2>\n<p>我们在 Google Analytics 中调用自己网站的分析数据时，需要首先开启 Google Analytics API，获取到鉴权密钥，才可以正常调用 API。我们可以根据 Google 官方教程：<a href=\"https://developers.google.com/analytics/devguides/reporting/core/v4/quickstart/service-py#1_enable_the_api\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Analytics Reporting API v4 - Enable the API</a>，或按照下面的办法来开启我们账户的 Google Analytics API：</p>\n<ul>\n<li>首先，前往官方 API 的 <a href=\"https://console.developers.google.com/start/api?id=analyticsreporting.googleapis.com&#x26;credential=client_key\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">setup tools</a> 并根据提示进行设置，选择一个项目（或创建新的项目，比如 <code class=\"language-text\">ga-hit-count</code>），之后选择 Continue，就可以为我们这一项目开启 Google API 了；\n<figure><img src=\"https://cdn.spencer.felinae98.cn/blog/2020/07/20200722-213128-1.png\" alt=\"为我们的项目开启 Google API\"><figcaption>为我们的项目开启 Google API</figcaption></figure></li>\n<li>接下来，我们会进入 Google API 的 Credentials 设置页面，这里我们首先设置 API 为 Analytics Reporting API，并选择 API 调用方为 Web server，再选择调用数据类型为 Application data，最后选择「不会使用 App Engine 或 Compute Engine」即可；\n<figure><img src=\"https://cdn.spencer.felinae98.cn/blog/2020/07/20200722-213128-2.png\" alt=\"设置 Google API 类型\"><figcaption>设置 Google API 类型</figcaption></figure></li>\n<li>最后，我们设置基本信息，获取 Credentials 文件。我们设置 Service account name 的名字（比如 <code class=\"language-text\">blog-analytics</code>），设置 Role 为 <code class=\"language-text\">Service Account User</code>，选择 Key type 为 JSON，即可获取 API 凭证，点击 Continue 之后你就可以下载到这一 JSON 格式的 API 凭证文件了。 <figure><img src=\"https://cdn.spencer.felinae98.cn/blog/2020/07/20200722-213128-3.png\" alt=\"设置 API 凭证信息\"><figcaption>设置 API 凭证信息</figcaption></figure></li>\n</ul>\n<p>我们获取到的 JSON 文件里面应该包含有以下的重要信息：</p>\n<pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// ...</span>\n  <span class=\"token property\">\"project_id\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"ga-hit-count\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"private_key\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"-----BEGIN PRIVATE KEY-----\\nxxx-----END PRIVATE KEY-----\\n\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"client_email\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"blog-hit-count@ga-hit-count.iam.gserviceaccount.com\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p>其中，我们重点关注的就是这三个 API 凭证信息：项目 ID <code class=\"language-text\">project_id</code>、凭证私钥 <code class=\"language-text\">private_key</code> 以及客户邮箱 <code class=\"language-text\">client_email</code>。其中 <code class=\"language-text\">private_key</code> 是我们 API 访问的重要凭证，需要妥善保管，也一定不能签入 <code class=\"language-text\">git</code>。另外，我们需要将 <code class=\"language-text\">client_email</code> 定义的邮箱<strong>作为新用户加入 Google Analytics 后台</strong>，从而让这一邮箱访问到我们 Google Analytics 的数据。详见：<a href=\"https://support.google.com/analytics/answer/1009702\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Add, edit, and delete users and user groups</a>。</p>\n<figure><img src=\"https://cdn.spencer.felinae98.cn/blog/2020/07/20200722-213128-4.png\" alt=\"将 client_email 的邮箱加入 Google Analytics 后台\"><figcaption>将 client_email 的邮箱加入 Google Analytics 后台</figcaption></figure>\n<h2 id=\"使用-vercel-自己部署-serverless-api-用于前端显示\"><a href=\"#%E4%BD%BF%E7%94%A8-vercel-%E8%87%AA%E5%B7%B1%E9%83%A8%E7%BD%B2-serverless-api-%E7%94%A8%E4%BA%8E%E5%89%8D%E7%AB%AF%E6%98%BE%E7%A4%BA\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>使用 Vercel 自己部署 Serverless API 用于前端显示</h2>\n<p>最后，我们就可以借助 Google Analytics API 在 Vercel 上部署中转 API 用于前端静态网站的调用。这里我使用 Node.js 和 Typescript 写好了一个非常简单的基础 Serverless API 项目，位于：<a href=\"https://github.com/spencerwooo/ga-hit-count-serverless\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">spencerwooo/ga-hit-count-serverless</a>，同学们可以直接 Fork 我的这一项目用来自己部署。其中，如果自己没有特殊需要，那么 Fork 项目之后我们仅需要修改 <code class=\"language-text\">api/config.ts</code> 里面的配置即可导入 Vercel 一键部署。</p>\n<h3 id=\"修改-ga-hit-count-serverless-的配置\"><a href=\"#%E4%BF%AE%E6%94%B9-ga-hit-count-serverless-%E7%9A%84%E9%85%8D%E7%BD%AE\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>修改 <code class=\"language-text\">ga-hit-count-serverless</code> 的配置</h3>\n<p>同学们将这一项目 Fork 至自己的 GitHub 账户上后，进入 <code class=\"language-text\">api/config.ts</code> 即可看到我自己的 API 配置，大致如下：</p>\n<pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token punctuation\">{</span>\n  viewId<span class=\"token operator\">:</span> <span class=\"token string\">'{Google Analytics view ID}'</span><span class=\"token punctuation\">,</span>\n  auth<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    projectId<span class=\"token operator\">:</span> <span class=\"token string\">'{Google API project ID}'</span><span class=\"token punctuation\">,</span>\n    privateKey<span class=\"token operator\">:</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">PRIVATE_KEY</span><span class=\"token punctuation\">,</span>\n    clientEmail<span class=\"token operator\">:</span> <span class=\"token string\">'{Google API client email}'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  allFilter<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'{Post path filter}'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  startDate<span class=\"token operator\">:</span> <span class=\"token string\">'{Google API query start date}'</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p>其中，这些内容我们都需要一一进行设置：</p>\n<ul>\n<li><code class=\"language-text\">viewId</code>：是你的 Google Analytics 视图 ID，可以在 Google Analytics 后台的 Admin » View » View Settings 中找到；\n<figure><img src=\"https://cdn.spencer.felinae98.cn/blog/2020/07/20200722-213128-5.png\" alt=\"Google Analytics 视图 ID 的设定位置\"><figcaption>Google Analytics 视图 ID 的设定位置</figcaption></figure></li>\n<li><code class=\"language-text\">projectId</code>：是刚刚凭证 JSON 文件中的 <code class=\"language-text\">project_id</code>，直接按照刚刚的凭证填写即可；</li>\n<li><code class=\"language-text\">privateKey</code>：是通过 Vercel 环境变量获取到的 API 凭证私钥，<strong>这里不要更改</strong>；</li>\n<li><code class=\"language-text\">clientEmail</code>：是刚刚凭证 JSON 文件中的 <code class=\"language-text\">client_email</code>，直接按照刚刚的凭证填写即可；</li>\n<li><code class=\"language-text\">allFilter</code>：是通过 Google API 查询时的前缀过滤器，比如你的网站中文章路径以 <code class=\"language-text\">/post</code> 开头，那么就可以设置为 <code class=\"language-text\">[&#39;/post&#39;]</code>。默认为 <code class=\"language-text\">[&#39;/20&#39;]</code>（因为我的文章路径是以 <code class=\"language-text\">/2020</code> 或 <code class=\"language-text\">/2019</code> 开头的）；</li>\n<li><code class=\"language-text\">startDate</code>：是通过 Google API 查询时设定时间段的开始时间，设定一个比较久远的时间即可，默认为 <code class=\"language-text\">2010-01-01</code>。</li>\n</ul>\n<div class=\"admonition admonition-warning\"><div class=\"admonition-heading\"><h5><div class=\"admonition-icon\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"12\" height=\"16\" viewBox=\"0 0 12 16\"><path fill-rule=\"evenodd\" d=\"M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z\"></path></svg></div>🚨 请注意！</h5></div><div class=\"admonition-content\"><p>这里千万千万不要直接将刚刚凭证中获取到的私钥直接粘贴进入 <code class=\"language-text\">privateKey</code> 一项之中，因为这样当我们将 <code class=\"language-text\">config.ts</code> 签入 <code class=\"language-text\">git</code> 之后，<code class=\"language-text\">privateKey</code> 将以明文形式保存，非常危险。</p></div></div>\n<h3 id=\"将项目导入-vercel\"><a href=\"#%E5%B0%86%E9%A1%B9%E7%9B%AE%E5%AF%BC%E5%85%A5-vercel\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>将项目导入 Vercel</h3>\n<p>Vercel（曾经的 ZEIT Now）是一个专注于部署 Jamstack 静态网页和 Serverless API 的服务，其官网位于 <a href=\"https://vercel.com/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Develop. Preview. Ship. - Vercel</a>。我们使用 GitHub 注册登录 Vercel 之后，仅需将刚刚 Fork 并修改好配置文件版本的 <code class=\"language-text\">ga-hit-count-serverless</code> 导入 Vercel 即可。Vercel 会自动的识别我们项目的环境，生成合适的编译、部署命令，自动将我们的 API 部署到 Vercel 的全球 CDN 上面，方便全世界随时随地的访问。</p>\n<p>但是此时我们并不能正常的使用我们自己部署的 API，因为 <code class=\"language-text\">privateKey</code> 尚未设置。我们需要进入刚刚在 Vercel 上部署好的项目设置中，选择 General » Environment Variables，向其中新增一个环境变量 <code class=\"language-text\">PRIVATE_KEY</code>。之后，我们将刚刚的 Google API JSON 凭证文件里面的私钥，<strong>复制其中的字符串部分，将 <code class=\"language-text\">\\n</code> 全部删掉并更换为换行</strong>，得到类似如下的多行私钥形式：</p>\n<pre class=\"language-text\"><code class=\"language-text\">-----BEGIN PRIVATE KEY-----\ndageWvAIBADANBAokdP8WgkqhkiGkk\n...\nafROdsafbliOjPA==1Hk3mdsafEdBa\n-----END PRIVATE KEY-----</code></pre>\n<p>我们复制这一私钥，再粘贴进入刚刚新建的 <code class=\"language-text\">PRIVATE_KEY</code> 的值。</p>\n<figure><img src=\"https://cdn.spencer.felinae98.cn/blog/2020/07/20200722-213128-6.png\" alt=\"在 Vercel 项目的设置中添加环境变量 PRIVATE_KEY，并存入我们的私钥凭证\"><figcaption>在 Vercel 项目的设置中添加环境变量 PRIVATE_KEY，并存入我们的私钥凭证</figcaption></figure>\n<p>之后，我们需要重新触发一次部署（比如随便向 GitHub 仓库中 commit 并 push 一些东西），完成后我们即可通过 Vercel 给我们提供的域名 <code class=\"language-text\">https://{VERCEL_DOMAIN_NAME}.vercel.app</code> 访问我们的 API。</p>\n<h3 id=\"使用-vercel-serverless-版-api\"><a href=\"#%E4%BD%BF%E7%94%A8-vercel-serverless-%E7%89%88-api\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>使用 Vercel Serverless 版 API</h3>\n<p>默认情况下，当我们直接访问 <code class=\"language-text\">https://{VERCEL_DOMAIN_NAME}.vercel.app</code> 时，因为没有设定 <code class=\"language-text\">index.html</code>，所以 Vercel 会将当前列表下的文件列出。</p>\n<figure><img src=\"https://cdn.spencer.felinae98.cn/blog/2020/07/20200722-213128-7.png\" alt=\"默认情况下直接访问 Vercel 上部署的 Serverless API 域名\"><figcaption>默认情况下直接访问 Vercel 上部署的 Serverless API 域名</figcaption></figure>\n<p>我们 API 的根域名实际上就是 <code class=\"language-text\">https://{VERCEL_DOMAIN_NAME}.vercel.app</code>。我们可以通过下面的默认请求（添加在 API 根域名后面）来访问 API：</p>\n<pre class=\"language-text\"><code class=\"language-text\">/api/ga</code></pre>\n<p>没有添加任何参数的情况下，默认这一 API 会将你的 Google Analytics 里面全部路径与访问量拉取并给出。以我自己博客为例，访问这一 API 会得到类似下面的 JSON response：</p>\n<pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">[</span>\n  <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"page\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"/2019/11/tiny-tiny-rss/\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"hit\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"698\"</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"page\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"/2019/11/weibo-to-twitter/\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"hit\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"531\"</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"page\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"/2020/03/ttrss-noteworthy/\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"hit\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"357\"</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">]</span></code></pre>\n<p>其中，我们可以看到返回的 response 中包含有我们网站中所有路径的 <code class=\"language-text\">hit</code> 阅读量数据，并且数据是按照阅读量递减来排列的。</p>\n<p>当我们需要直接请求网站中某一页面或某个特定路径的数据时，我们可以用这样的语法构造我们的请求：</p>\n<pre class=\"language-text\"><code class=\"language-text\">/api/ga?page={WEBSITE_PAGE_PATH}</code></pre>\n<p>其中请求的 field 为 <code class=\"language-text\">page</code>，参数为目标路径。比如这样的请求：</p>\n<pre class=\"language-text\"><code class=\"language-text\">/api/ga?page=/2020/03/substats/</code></pre>\n<p>将直接返回路径 <code class=\"language-text\">/2020/03/substats/</code> 的阅读量：</p>\n<pre class=\"language-text\"><code class=\"language-text\">[\n  {\n    &quot;page&quot;: &quot;/2020/03/substats/&quot;,\n    &quot;hit&quot;: &quot;311&quot;\n  }\n]</code></pre>\n<p>那么在此基础上，我们即可借助自己在 Vercel 上面部署的 API，来请求 Google Analytics 给我们当前路径的浏览量记录了。利用 <code class=\"language-text\">axios</code> 或者类似的前端 HTTP 请求库，我们可以非常轻松的请求我们部署的 Serverless API，并将结果进行处理，显示在我们的网站里面。你正在浏览的我的博客，就是利用这样的原理实现访问数据的显示。</p>\n<figure><img src=\"https://cdn.spencer.felinae98.cn/blog/2020/07/20200722-213128-8.png\" alt=\"用这样的方法在我自己博客上面显示文章的浏览量\"><figcaption>用这样的方法在我自己博客上面显示文章的浏览量</figcaption></figure>\n<p>到此，我们借助 Google Analytics 和 Vercel Serverless 为文章添加浏览量统计的功能就大功告成了。希望大家能用上本文的办法，为自己的静态博客网站快速添加上文章阅读量统计。感谢阅读 🍒</p>\n"}},{"node":{"title":"Substats：快速统计你在各个平台的关注者！","path":"/2020/03/substats/","date":"March 16. 2020","timeToRead":8,"cjkWordCount":1795,"cjkReadTime":8,"description":"Subscriber statistics：专注提供各个网站和社区里用户的订阅者、关注者、粉丝数量的 Serverless API","content":"<div class=\"admonition admonition-important\"><div class=\"admonition-heading\"><h5><div class=\"admonition-icon\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"14\" height=\"16\" viewBox=\"0 0 14 16\"><path fill-rule=\"evenodd\" d=\"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z\"></path></svg></div>SUBSTATS</h5></div><div class=\"admonition-content\"><p>Serverless Function to Count How Many People are Subscribed to You in Your Favorite Services.\n<strong>你只管调用，我们来帮你找订阅者！</strong></p></div></div>\n<p>在 <a href=\"https://blog.spencerwoo.com/2020/03/ttrss-noteworthy/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">上一篇文章</a> 里面，我在开头用 Feedly 的 API 和 Shields.io 制作了显示我 RSS 订阅数量的 Badge。这个 Badge 不仅是实时更新、动态加载的，还能轻松嵌入各个网页里面。</p>\n<p><a href=\"https://feedly.com/i/subscription/feed%2Fhttps%3A%2F%2Fblog.spencerwoo.com%2Fposts%2Findex.xml\"><img src=\"https://img.shields.io/badge/dynamic/json?color=2bb24c&amp;label=subscribers&amp;query=%24.source.subscribers&amp;url=https%3A%2F%2Ffeedly.com%2Fv3%2Frecommendations%2Ffeeds%2Ffeed%252Fhttps%253A%252F%252Fblog.spencerwoo.com%252Fposts%252Findex.xml&amp;logo=feedly&style=for-the-badge\" alt=\"\" style=\"display: inline; margin: 0 0.1rem 0 0; width: auto;\"></a></p>\n<p>但是，RSS 订阅服务不仅仅有 Feedly 一家，还有 Inoreader 和 NewsBlur 等等。单一个 Feedly 提供的数据并不能真正显示我们 RSS 链接的订阅人数，于是，我就准备用 Serverless 技术搭建一个「API 中转站」，<strong>提供多个服务商的订阅人数整合的工作。</strong></p>\n<p>其实，最初的 Substats 实际上叫做 RSS-stats，也就是集合多个 RSS 服务商提供的订阅人数数据得到的一个 API 服务。但是后来经过我一番思考，既然都是调用 API，那么为什么不把其他的平台和服务，比如微博粉丝、知乎、少数派、以及 GitHub 和 Twitter 的关注者等等，一起支持一下呢？💡 可行！于是 Substats 就这样诞生啦。(≧∇≦)ﾉ</p>\n<div class=\"admonition admonition-tip\"><div class=\"admonition-heading\"><h5><div class=\"admonition-icon\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"12\" height=\"16\" viewBox=\"0 0 12 16\"><path fill-rule=\"evenodd\" d=\"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z\"></path></svg></div>相关链接</h5></div><div class=\"admonition-content\"><ul>\n<li><strong>Substats API 地址</strong>：<a href=\"https://api.spencerwoo.com/substats/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">API - Substats</a></li>\n<li><strong>Substats GitHub 项目地址</strong>：<a href=\"https://github.com/spencerwooo/Substats\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">spencerwooo/Substats</a></li>\n</ul></div></div>\n<h2 id=\"功能特性\"><a href=\"#%E5%8A%9F%E8%83%BD%E7%89%B9%E6%80%A7\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>功能特性</h2>\n<p>Substats 是一个非常方便易用的<strong>请求订阅者、粉丝、关注用户数量 API 服务</strong>。目前，Substats 平台支持了包括 Feedly、GitHub、Twitter、知乎和少数派在内的五个平台和网站，并使用 Serverless 技术部署到了 Cloudflare 的 CDN 上，全球部署，飞速响应。Substats 将复杂的原平台 API 请求进行了隐藏、简化和集成，让用 Substats 的你只需要关注<strong>两个参数：平台名称、用户名称</strong>，一波访问，即可得到对应的关注数量。</p>\n<p>得益于强大的 Cloudflare 全球 CDN 网络，Substats 不仅部署方便、维护轻松，<strong>还有着极强的可拓展性、极快的访问速度和极小的请求时延</strong>。甚至在你懂得的地方，你都可以轻松访问到 Twitter 的粉丝数量！🥂</p>\n<h3 id=\"api-endpoint\"><a href=\"#api-endpoint\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>API Endpoint</h3>\n<p>Substats 的请求非常简单，基础 API Endpoint 位于：</p>\n<pre class=\"language-text\"><code class=\"language-text\">https://api.spencerwoo.com/substats/</code></pre>\n<p>接下来，我们只需要关注前文提到的平台名 <code class=\"language-text\">source</code> 和用户名称（或 RSS 链接、用户 slug 等标识）<code class=\"language-text\">queryKey</code> 即可构造一个基本的请求。为了更好的和 Shields.io 整合，Substats 仅支持 <code class=\"language-text\">GET</code> 请求，并使用查询字符串（Query String）来添加请求参数。</p>\n<h3 id=\"基础请求\"><a href=\"#%E5%9F%BA%E7%A1%80%E8%AF%B7%E6%B1%82\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>基础请求</h3>\n<p>一个最基础的请求参数类似：</p>\n<pre class=\"language-http\"><code class=\"language-http\">GET /?source={SOURCE}&amp;queryKey={QUERY}</code></pre>\n<p>其中，我们只需要填入平台名称 <code class=\"language-text\">{SOURCE}</code> 和请求参数 <code class=\"language-text\">{QUERY}</code> 即可。</p>\n<h3 id=\"平台串联请求\"><a href=\"#%E5%B9%B3%E5%8F%B0%E4%B8%B2%E8%81%94%E8%AF%B7%E6%B1%82\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>平台串联请求</h3>\n<p>我们可以用下面的语法构建单个请求 query 并列请求多个平台的 API，只需要将平台之间用 <code class=\"language-text\">|</code> 分隔即可：</p>\n<pre class=\"language-http\"><code class=\"language-http\">GET /?source={SOURCE_1}|{SOURCE_2}|{SOURCE_3}&amp;queryKey={QUERY}</code></pre>\n<p>其中，这一请求格式特别适合 RSS 订阅的请求，比如当我们想统计同一个 RSS 链接在 Feedly、Inoreader 以及 NewsBlur 三个平台的订阅者数量，即可使用这一语法进行 API 请求。（详见下文例子）</p>\n<h3 id=\"多个平台和用户名的串联请求\"><a href=\"#%E5%A4%9A%E4%B8%AA%E5%B9%B3%E5%8F%B0%E5%92%8C%E7%94%A8%E6%88%B7%E5%90%8D%E7%9A%84%E4%B8%B2%E8%81%94%E8%AF%B7%E6%B1%82\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>多个平台和用户名的串联请求</h3>\n<pre class=\"language-http\"><code class=\"language-http\">GET /?source={SOURCE}&amp;queryKey={QUERY}&amp;source={SOURCE}&amp;queryKey={QUERY} ....</code></pre>\n<p>如果我们每个平台的请求参数（也就是用户名）不一样，没关系，我们也可以用上面的语法组织各个 <code class=\"language-text\">[平台, 参数]</code> 二元组，依次请求，得到最终数据。在这一过程中，平台、参数的顺序在请求和内部 API 处理的过程中是完全一致的。（你也就不必担心请求的错位。）</p>\n<h2 id=\"一些例子\"><a href=\"#%E4%B8%80%E4%BA%9B%E4%BE%8B%E5%AD%90\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>一些例子</h2>\n<p>将 Substats 和 <a href=\"https://shields.io/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Shields.io</a> 配合起来，我们可以构造稳定可用的关注者数量实时显示 Badge，嵌入包括 GitHub README、博客文章等等网站的各个位置。我来举个栗子。🌰</p>\n<h3 id=\"单个请求\"><a href=\"#%E5%8D%95%E4%B8%AA%E8%AF%B7%E6%B1%82\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>单个请求</h3>\n<p>Substats 最初就是为了请求 RSS 订阅者数量，我们先来请求一波 Feedly 的订阅数量。我自己博客（也就是本博客）的 RSS 订阅链接是 <code class=\"language-text\">https://blog.spencerwoo.com/feed.xml</code>，那么，我们就可以用下面的 URL 构造请求：</p>\n<pre class=\"language-http\"><code class=\"language-http\">GET /?source=feedly&amp;queryKey=https://blog.spencerwoo.com/feed.xml</code></pre>\n<p>这一请求会返回如下的数据：</p>\n<pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"status\"</span><span class=\"token operator\">:</span> <span class=\"token number\">200</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"data\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"totalSubs\"</span><span class=\"token operator\">:</span> <span class=\"token number\">14</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"subsInEachSource\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token property\">\"feedly\"</span><span class=\"token operator\">:</span> <span class=\"token number\">14</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"failedSources\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p>我们所需要的数据即位于：<code class=\"language-text\">data.totalSubs</code>。在 <a href=\"https://shields.io/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Shields.io</a> 官网，我们即可借助 Dynamic Badge 构建一个自定义的 Badge：</p>\n<ul>\n<li><code class=\"language-text\">data type</code> 选择：<code class=\"language-text\">json</code></li>\n<li><code class=\"language-text\">label</code> 填入：Feedly RSS Subscribes</li>\n<li><code class=\"language-text\">data url</code> 填入：<code class=\"language-text\">https://api.spencerwoo.com/substats/?source=feedly&amp;queryKey=https://blog.spencerwoo.com/feed.xml</code></li>\n<li><code class=\"language-text\">query</code> 填入：<code class=\"language-text\">$.data.totalSubs</code></li>\n<li><code class=\"language-text\">color</code> 填入：<code class=\"language-text\">2bb24c</code>（Feedly 的强调色）</li>\n</ul>\n<p>点击 Make badge，即可生成如下的 Feedly RSS 订阅 Badge：</p>\n<p><a href=\"https://feedly.com/i/subscription/feed%2Fhttps%3A%2F%2Fblog.spencerwoo.com%2Fposts%2Findex.xml\"><img src=\"https://img.shields.io/badge/dynamic/json?color=2bb24c&label=Feedly%20RSS%20Subscribes&query=%24.data.totalSubs&url=https%3A%2F%2Fapi.spencerwoo.com%2Fsubstats%2F%3Fsource%3Dfeedly%26queryKey%3Dhttps%3A%2F%2Fblog.spencerwoo.com%2Fposts%2Findex.xml\" alt=\"\" style=\"display: inline; margin: 0 0.1rem 0 0; width: auto;\"></a></p>\n<pre class=\"language-text\"><code class=\"language-text\">https://img.shields.io/badge/dynamic/json?color=2bb24c&amp;label=Feedly%20RSS%20Subscribes&amp;query=%24.data.totalSubs&amp;url=https%3A%2F%2Fapi.spencerwoo.com%2Fsubstats%2F%3Fsource%3Dfeedly%26queryKey%3Dhttps%3A%2F%2Fblog.spencerwoo.com%2Fposts%2Findex.xml</code></pre>\n<p>在这一请求链接的结尾，再手动添加上 Feedly 的 logo 请求参数 <code class=\"language-text\">&amp;logo=feedly</code>，即可将 Badge 添加上图标：</p>\n<p><a href=\"https://feedly.com/i/subscription/feed%2Fhttps%3A%2F%2Fblog.spencerwoo.com%2Fposts%2Findex.xml\"><img src=\"https://img.shields.io/badge/dynamic/json?color=2bb24c&label=Feedly%20RSS%20Subscribes&query=%24.data.totalSubs&url=https%3A%2F%2Fapi.spencerwoo.com%2Fsubstats%2F%3Fsource%3Dfeedly%26queryKey%3Dhttps%3A%2F%2Fblog.spencerwoo.com%2Fposts%2Findex.xml&logo=feedly\" alt=\"\" style=\"display: inline; margin: 0 0.1rem 0 0; width: auto;\"></a></p>\n<pre class=\"language-text\"><code class=\"language-text\">https://img.shields.io/badge/dynamic/json?color=2bb24c&amp;label=Feedly%20RSS%20Subscribes&amp;query=%24.data.totalSubs&amp;url=https%3A%2F%2Fapi.spencerwoo.com%2Fsubstats%2F%3Fsource%3Dfeedly%26queryKey%3Dhttps%3A%2F%2Fblog.spencerwoo.com%2Fposts%2Findex.xml&amp;logo=feedly</code></pre>\n<p>另外，我们还可以指定生成超大 For The Badge 风格的 Badge，在上面请求末尾再手动添加参数 <code class=\"language-text\">&amp;style=for-the-badge</code> 即可：</p>\n<p><a href=\"https://feedly.com/i/subscription/feed%2Fhttps%3A%2F%2Fblog.spencerwoo.com%2Fposts%2Findex.xml\"><img src=\"https://img.shields.io/badge/dynamic/json?color=2bb24c&label=Feedly%20RSS%20Subscribes&query=%24.data.totalSubs&url=https%3A%2F%2Fapi.spencerwoo.com%2Fsubstats%2F%3Fsource%3Dfeedly%26queryKey%3Dhttps%3A%2F%2Fblog.spencerwoo.com%2Fposts%2Findex.xml&logo=feedly&style=for-the-badge\" alt=\"\" style=\"display: inline; margin: 0 0.1rem 0 0; width: auto;\"></a></p>\n<pre class=\"language-text\"><code class=\"language-text\">https://img.shields.io/badge/dynamic/json?color=2bb24c&amp;label=Feedly%20RSS%20Subscribes&amp;query=%24.data.totalSubs&amp;url=https%3A%2F%2Fapi.spencerwoo.com%2Fsubstats%2F%3Fsource%3Dfeedly%26queryKey%3Dhttps%3A%2F%2Fblog.spencerwoo.com%2Fposts%2Findex.xml&amp;logo=feedly&amp;style=for-the-badge</code></pre>\n<h3 id=\"多个平台串联请求\"><a href=\"#%E5%A4%9A%E4%B8%AA%E5%B9%B3%E5%8F%B0%E4%B8%B2%E8%81%94%E8%AF%B7%E6%B1%82\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>多个平台串联请求</h3>\n<p>当然，我们可以用 <code class=\"language-text\">|</code> 串联多个请求，比如我同时请求 Feedly、Inoreader 中订阅我 RSS 链接的用户数量：</p>\n<pre class=\"language-http\"><code class=\"language-http\">GET /?source=feedly|inoreader&amp;queryKey=https://blog.spencerwoo.com/feed.xml</code></pre>\n<p>我们会得到如下数据（截至发文 Inoreader 的 API 尚未实现，我正在咨询 Inoreader 平台方是否提供 API 接口）：</p>\n<pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"status\"</span><span class=\"token operator\">:</span> <span class=\"token number\">200</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"data\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"totalSubs\"</span><span class=\"token operator\">:</span> <span class=\"token number\">14</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"subsInEachSource\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token property\">\"feedly\"</span><span class=\"token operator\">:</span> <span class=\"token number\">14</span><span class=\"token punctuation\">,</span> <span class=\"token property\">\"inoreader\"</span><span class=\"token operator\">:</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"failedSources\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"inoreader\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Not implemented\"</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p><a href=\"https://feedly.com/i/subscription/feed%2Fhttps%3A%2F%2Fblog.spencerwoo.com%2Fposts%2Findex.xml\"><img src=\"https://img.shields.io/badge/dynamic/json?label=RSS%20subs&query=%24.data.totalSubs&url=https%3A%2F%2Fapi.spencerwoo.com%2Fsubstats%2F%3Fsource%3Dfeedly%257Cinoreader%26queryKey%3Dhttps%3A%2F%2Fblog.spencerwoo.com%2Fposts%2Findex.xml&color=ffa500&logo=rss&style=for-the-badge\" alt=\"\" style=\"display: inline; margin: 0 0.1rem 0 0; width: auto;\"></a></p>\n<h3 id=\"多平台多请求参数串联请求\"><a href=\"#%E5%A4%9A%E5%B9%B3%E5%8F%B0%E5%A4%9A%E8%AF%B7%E6%B1%82%E5%8F%82%E6%95%B0%E4%B8%B2%E8%81%94%E8%AF%B7%E6%B1%82\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>多平台多请求参数串联请求</h3>\n<p>当每个平台的请求参数（用户名）不一样时，我们可以串联多个请求参数并行请求，比如我希望统计「少数派」平台和「Twitter」平台的粉丝，但是我在这两个平台上面的用户名分别是 <code class=\"language-text\">spencerwoo</code> 和 <code class=\"language-text\">realSpencerWoo</code>，我们即可用下面的方法构造请求：</p>\n<pre class=\"language-http\"><code class=\"language-http\">GET /?source=sspai&amp;queryKey=spencerwoo&amp;source=twitter&amp;queryKey=realSpencerWoo</code></pre>\n<p>我们会得到如下数据：</p>\n<pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"status\"</span><span class=\"token operator\">:</span> <span class=\"token number\">200</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"data\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"totalSubs\"</span><span class=\"token operator\">:</span> <span class=\"token number\">756</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"subsInEachSource\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token property\">\"sspai\"</span><span class=\"token operator\">:</span> <span class=\"token number\">636</span><span class=\"token punctuation\">,</span> <span class=\"token property\">\"twitter\"</span><span class=\"token operator\">:</span> <span class=\"token number\">120</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"failedSources\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p>这样，我们即可非常轻松的构造这样的三个 Badge：</p>\n<p><a href=\"https://api.spencerwoo.com/substats/?source=sspai&queryKey=spencerwoo&source=twitter&queryKey=realSpencerWoo\"><img src=\"https://img.shields.io/badge/dynamic/json?label=Social%20media&query=%24.data.totalSubs&url=https%3A%2F%2Fapi.spencerwoo.com%2Fsubstats%2F%3Fsource%3Dsspai%26queryKey%3Dspencerwoo%26source%3Dtwitter%26queryKey%3DrealSpencerWoo&color=brightgreen&style=for-the-badge\" alt=\"\" style=\"display: inline; margin: 0 0.1rem 0 0; width: auto;\"></a>\n<a href=\"https://api.spencerwoo.com/substats/?source=sspai&queryKey=spencerwoo&source=twitter&queryKey=realSpencerWoo\"><img src=\"https://img.shields.io/badge/dynamic/json?label=%E5%B0%91%E6%95%B0%E6%B4%BE&query=%24.data.subsInEachSource.sspai&url=https%3A%2F%2Fapi.spencerwoo.com%2Fsubstats%2F%3Fsource%3Dsspai%26queryKey%3Dspencerwoo%26source%3Dtwitter%26queryKey%3DrealSpencerWoo&color=d71a1b&style=for-the-badge\" alt=\"\" style=\"display: inline; margin: 0 0.1rem 0 0; width: auto;\"></a>\n<a href=\"https://api.spencerwoo.com/substats/?source=sspai&queryKey=spencerwoo&source=twitter&queryKey=realSpencerWoo\"><img src=\"https://img.shields.io/badge/dynamic/json?label=Twitter&query=%24.data.subsInEachSource.twitter&url=https%3A%2F%2Fapi.spencerwoo.com%2Fsubstats%2F%3Fsource%3Dsspai%26queryKey%3Dspencerwoo%26source%3Dtwitter%26queryKey%3DrealSpencerWoo&color=1da1f2&logo=twitter&style=for-the-badge\" alt=\"\" style=\"display: inline; margin: 0 0.1rem 0 0; width: auto;\"></a></p>\n<h2 id=\"小结\"><a href=\"#%E5%B0%8F%E7%BB%93\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>小结</h2>\n<p>这些就是 Substats 的特别之处，Substats 不仅整合了原服务复杂的 API，还拥有方便的请求构建方法。与 <a href=\"https://shields.io/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Shields.io</a> 配合，我们可以及其方便的构造自定义 Badge。虽然当前 Substats 支持的服务平台还比较少，但是整合其他服务 API 的方法还是相当方便的，欢迎同学们帮我来共同整合其他平台，一起将 Substats 发扬壮大 ( •̀ ω •́ )✧</p>\n<p><strong>最后，如果你觉得 Substats 非常棒，请不要吝啬你的 Star！你们的支持是我输出的最大动力 φ(*￣0￣)</strong></p>\n<p><a href=\"https://github.com/spencerwooo/Substats\"><img src=\"https://img.shields.io/github/stars/spencerwooo/Substats?logo=github&style=social\" alt=\"\" style=\"display: inline; margin: 0 0.1rem 0 0; width: auto;\"></a></p>\n"}}]}}},"context":{}}